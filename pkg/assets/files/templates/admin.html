<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TokenRouter Admin</title>
  <script>
    (function () {
      var key = 'opp_theme_mode_v1';
      var mode = 'auto';
      try {
        var stored = String(window.localStorage.getItem(key) || '').trim();
        if (stored === 'light' || stored === 'dark' || stored === 'auto') mode = stored;
      } catch (_) {}
      var resolved = mode;
      if (mode === 'auto') {
        try {
          resolved = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
        } catch (_) {
          resolved = 'light';
        }
      }
      document.documentElement.setAttribute('data-bs-theme', resolved);
    })();
  </script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script defer src="/admin/static/admin.api.js"></script>
  <script defer src="/admin/static/admin.realtime.js"></script>
  <script defer src="/admin/static/admin.toast.js"></script>
  <script defer src="/admin/static/admin.js"></script>
  <style>
    [data-bs-theme="light"] body {
      background-color: #eef2f6 !important;
    }

    [data-bs-theme="dark"] body {
      background-color: #343b46 !important;
    }

    .auth-choice-btn {
      min-height: 120px;
    }
    .provider-preset-btn {
      background-color: var(--bs-tertiary-bg);
    }
    .provider-preset-btn:hover,
    .provider-preset-btn:focus {
      background-color: var(--bs-secondary-bg);
    }
    [data-bs-theme="dark"] .provider-icon-invert-dark {
      filter: invert(1) brightness(1.12);
    }

    .form-switch .form-check-input {
      width: 2.6em;
      height: 1.3em;
      cursor: pointer;
      margin-right: 0.55rem;
    }

    .form-switch .form-check-label {
      padding-top: 0.05rem;
    }

    .icon-btn {
      border: 0;
      background: transparent;
      color: var(--bs-body-color);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 2rem;
      min-height: 2rem;
      padding: 0.15rem 0.35rem;
      border-radius: 0.375rem;
      line-height: 1;
      font-size: 1.35rem;
      cursor: pointer;
    }

    .icon-btn:hover,
    .icon-btn:focus-visible {
      background: color-mix(in srgb, var(--bs-secondary-bg) 70%, transparent);
      outline: none;
    }

    .icon-btn svg {
      width: 1.25rem !important;
      height: 1.25rem !important;
    }

    .icon-btn-danger {
      color: var(--bs-danger-text-emphasis);
    }

    .icon-btn[disabled] {
      opacity: 0.45;
      cursor: default;
      pointer-events: none;
    }

    .nav-tabs .nav-link.active {
      box-shadow:
        -6px 0 10px -8px color-mix(in srgb, var(--bs-primary) 45%, transparent),
        6px 0 10px -8px color-mix(in srgb, var(--bs-primary) 45%, transparent);
    }
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-body-tertiary">
<div class="container-fluid px-4 py-4" x-data="adminApp()" x-init="init()">
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex align-items-start justify-content-between gap-2">
        <div>
          <h1 class="h3 mb-1 d-flex align-items-center gap-2">
            <img src="/admin/static/tokenrouter.svg" alt="" width="28" height="28" style="object-fit:contain;" />
            <span>TokenRouter</span>
            <small class="text-body-secondary fw-normal" x-show="appVersion" style="display:none;" x-text="appVersion"></small>
          </h1>
        </div>
        <div class="d-flex gap-2">
          <button
            class="icon-btn"
            type="button"
            @click="cycleTheme()"
            :title="themeButtonLabel()"
            :aria-label="themeButtonLabel()"
          >
            <span aria-hidden="true" x-html="themeButtonIcon()"></span>
          </button>
          <form method="post" action="/admin/logout">
            <button class="btn btn-sm btn-outline-secondary" type="submit">Log out</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <ul class="nav nav-tabs mb-0">
    <li class="nav-item">
      <button class="nav-link rounded-top" :class="activeTab==='status' ? 'active fw-semibold' : 'text-body-secondary border border-secondary'" @click="selectTab('status')">Status</button>
    </li>
    <li class="nav-item">
      <button class="nav-link rounded-top" :class="activeTab==='quota' ? 'active fw-semibold' : 'text-body-secondary border border-secondary'" @click="selectTab('quota')">Quota</button>
    </li>
    <li class="nav-item">
      <button class="nav-link rounded-top" :class="activeTab==='providers' ? 'active fw-semibold' : 'text-body-secondary border border-secondary'" @click="selectTab('providers')">Providers</button>
    </li>
    <li class="nav-item">
      <button class="nav-link rounded-top" :class="activeTab==='access' ? 'active fw-semibold' : 'text-body-secondary border border-secondary'" @click="selectTab('access')">Access</button>
    </li>
    <li class="nav-item">
      <button class="nav-link rounded-top" :class="activeTab==='models' ? 'active fw-semibold' : 'text-body-secondary border border-secondary'" @click="selectTab('models')">Models</button>
    </li>
    <li class="nav-item">
      <button class="nav-link rounded-top" :class="activeTab==='conversations' ? 'active fw-semibold' : 'text-body-secondary border border-secondary'" @click="selectTab('conversations')">Conversations</button>
    </li>
    <li class="nav-item">
      <button class="nav-link rounded-top" :class="activeTab==='log' ? 'active fw-semibold' : 'text-body-secondary border border-secondary'" @click="selectTab('log')">Log</button>
    </li>
  </ul>

  <div x-show="activeTab==='status'" style="display:none;">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 mb-0">Usage Stats</h2>
          <div class="d-flex align-items-center gap-2">
            <select class="form-select form-select-sm" style="width:auto;" x-model="statusUpdateSpeed" @change="setStatusUpdateSpeed($event.target.value)">
              <option value="realtime">realtime</option>
              <option value="2s">2s</option>
              <option value="10s">10s</option>
              <option value="30s">30s</option>
              <option value="1m">1m</option>
              <option value="5m">5m</option>
              <option value="15m">15m</option>
              <option value="disabled">disabled</option>
            </select>
            <select class="form-select form-select-sm" style="width:auto;" x-model="statsRangeHours" @change="setStatsRangeHours($event.target.value)">
              <option value="1">1h</option>
              <option value="4">4h</option>
              <option value="8">8h</option>
              <option value="24">24h</option>
              <option value="72">72h</option>
            </select>
            <button class="btn btn-sm btn-outline-primary" @click="loadStats(true)">Refresh</button>
          </div>
        </div>
        <div x-html="statsSummaryHtml"></div>
      </div>
    </div>
  </div>

  <div x-show="activeTab==='conversations'" style="display:none;">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex flex-wrap align-items-start justify-content-between gap-2 mb-2">
          <h2 class="h5 mb-0">Conversations</h2>
          <div class="d-flex flex-wrap align-items-center gap-2">
            <button class="icon-btn" title="Conversation settings" aria-label="Conversation settings" @click="openConversationsSettingsModal()">⚙</button>
            <input class="form-control form-control-sm" style="width:320px;" placeholder="Filter conversations..." x-model.trim="conversationsSearch" @input="debouncedLoadConversations()" />
            <button class="btn btn-sm btn-outline-primary" @click="loadConversations()">Refresh</button>
          </div>
        </div>
        <div class="border rounded p-2" style="max-height:68vh; overflow:auto;" x-html="conversationsListHtml"></div>
        <div x-html="conversationsPagerHtml"></div>
        <div class="small text-body-secondary mt-2">Click a conversation to open chat view.</div>
      </div>
    </div>
  </div>

  <div x-show="showConversationDetailModal" style="display:none;" class="position-fixed top-0 start-0 w-100 h-100" @keydown.escape.window="closeConversationDetailModal()">
    <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark" style="opacity:0.55;" @click="closeConversationDetailModal()"></div>
    <div class="position-relative d-flex align-items-center justify-content-center h-100 p-3">
      <div class="card shadow" style="width:100%;max-width:1100px;max-height:88vh;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="h5 mb-0">Conversation</h3>
          <button class="icon-btn" @click="closeConversationDetailModal()" title="Close" aria-label="Close">✕</button>
        </div>
        <div class="card-body" style="overflow:auto;max-height:calc(88vh - 58px);" x-html="conversationDetailHtml"></div>
      </div>
    </div>
  </div>

  <div x-show="showConversationsSettingsModal" style="display:none;" class="position-fixed top-0 start-0 w-100 h-100" @keydown.escape.window="closeConversationsSettingsModal()">
    <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark" style="opacity:0.5;" @click="closeConversationsSettingsModal()"></div>
    <div class="position-relative d-flex align-items-center justify-content-center h-100 p-3">
      <div class="card shadow" style="width:100%;max-width:560px;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="h5 mb-0">Conversation Settings</h3>
          <button class="icon-btn" @click="closeConversationsSettingsModal()" title="Close" aria-label="Close">✕</button>
        </div>
        <div class="card-body">
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="conversationsEnabled" x-model="conversationsSettings.enabled">
            <label class="form-check-label" for="conversationsEnabled">Enabled</label>
          </div>
          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label">Max items</label>
              <input class="form-control" type="number" min="100" max="200000" step="100" x-model.number="conversationsSettings.max_items" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Max age days</label>
              <input class="form-control" type="number" min="1" step="1" x-model.number="conversationsSettings.max_age_days" />
            </div>
          </div>
          <div class="small text-body-secondary mb-3">Retention applies to persisted conversation data.</div>
          <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-outline-secondary" @click="closeConversationsSettingsModal()">Cancel</button>
            <button class="btn btn-primary" :disabled="conversationsSaveInProgress" @click="saveConversationsSettings()">
              <span x-show="!conversationsSaveInProgress">Save</span>
              <span x-show="conversationsSaveInProgress">Saving...</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div x-show="activeTab==='log'" style="display:none;">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
          <h2 class="h5 mb-0">Log</h2>
          <div class="d-flex flex-wrap align-items-center gap-2">
            <button class="icon-btn" title="Log settings" aria-label="Log settings" @click="openLogSettingsModal()">⚙</button>
            <select class="form-select form-select-sm" style="width:auto;" x-model="logLevelFilter" @change="loadLogs()">
              <option value="all">all</option>
              <option value="debug">debug</option>
              <option value="info">info</option>
              <option value="warn">warn</option>
              <option value="error">error</option>
              <option value="fatal">fatal</option>
            </select>
            <input class="form-control form-control-sm" style="width:320px;" placeholder="Filter log entries..." x-model.trim="logSearch" @input="debouncedLoadLogs()" />
            <button class="btn btn-sm btn-outline-danger" @click="clearLogs()" :disabled="!logEntries || logEntries.length === 0">Clear log</button>
            <button class="btn btn-sm btn-outline-primary" @click="loadLogs()">Refresh</button>
          </div>
        </div>
        <div class="small text-body-secondary mb-2">Entries shown: <span x-text="logEntriesShownCount"></span> of <span x-text="logEntriesTotalCount"></span></div>
        <div class="border rounded p-2" style="max-height:70vh; overflow:auto;" x-html="logEntriesHtml"></div>
        <div x-html="logPagerHtml"></div>
      </div>
    </div>
  </div>

  <div x-show="showLogSettingsModal" style="display:none;" class="position-fixed top-0 start-0 w-100 h-100" @keydown.escape.window="closeLogSettingsModal()">
    <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark" style="opacity:0.5;" @click="closeLogSettingsModal()"></div>
    <div class="position-relative d-flex align-items-center justify-content-center h-100 p-3">
      <div class="card shadow" style="width:100%;max-width:520px;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="h5 mb-0">Log Settings</h3>
          <button class="icon-btn" :disabled="logSaveInProgress" @click="closeLogSettingsModal()" title="Close" aria-label="Close">✕</button>
        </div>
        <div class="card-body">
          <label class="form-label">Max lines</label>
          <input class="form-control" type="number" min="100" max="200000" step="100" x-model.number="logMaxLines" />
          <div class="small text-body-secondary mt-2">Controls how many log lines are persisted.</div>
          <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn btn-outline-secondary" :disabled="logSaveInProgress" @click="closeLogSettingsModal()">Cancel</button>
            <button class="btn btn-primary" :disabled="logSaveInProgress" @click="saveLogSettingsFromModal()">
              <span x-show="!logSaveInProgress">Save</span>
              <span x-show="logSaveInProgress">Saving...</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div x-show="activeTab==='quota'" style="display:none;">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 mb-0">Provider Quotas</h2>
          <button class="btn btn-sm btn-outline-primary" :disabled="quotaRefreshInProgress" @click="refreshQuota()">
            <span x-show="!quotaRefreshInProgress">Refresh</span>
            <span x-show="quotaRefreshInProgress">Refreshing...</span>
          </button>
        </div>
        <div x-html="quotaSummaryHtml"></div>
      </div>
    </div>
  </div>

  <div x-show="activeTab==='providers'" style="display:none;">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 mb-0">Providers</h2>
          <div class="d-flex gap-2">
            <button class="icon-btn" title="Provider settings" aria-label="Provider settings" @click="openProvidersSettingsModal()">⚙</button>
            <button class="btn btn-sm btn-primary" @click="openAddProviderModal()">Add Provider</button>
          </div>
        </div>
        <div class="table-responsive" x-html="providersTableHtml"></div>
      </div>
    </div>
  </div>

  <div x-show="activeTab==='access'" style="display:none;">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 mb-0">Access Tokens</h2>
          <div class="d-flex gap-2">
            <button class="icon-btn" title="Access settings" aria-label="Access settings" @click="openAccessSettingsModal()">⚙</button>
            <button class="btn btn-sm btn-primary" @click="openAddAccessTokenModal()">Add Key</button>
          </div>
        </div>
        <div class="table-responsive" x-html="accessTokensTableHtml"></div>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="mb-2"><h2 class="h5 mb-0">Let's Encrypt TLS</h2></div>
        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="tlsEnabled" x-model="tlsSettings.enabled">
          <label class="form-check-label" for="tlsEnabled">Enable automatic Let's Encrypt certificates</label>
        </div>
        <div x-show="tlsSettings.enabled" style="display:none;">
        <div class="row g-2 mb-2">
          <div class="col-md-6">
            <label class="form-label">External hostname</label>
            <input class="form-control" placeholder="example.yourdomain.com" x-model="tlsSettings.domain" />
          </div>
          <div class="col-md-6">
            <label class="form-label">ACME email (optional)</label>
            <input class="form-control" placeholder="ops@example.com" x-model="tlsSettings.email" />
          </div>
        </div>
        <div class="small text-body-secondary mb-3">ACME cache dir: <code x-text="tlsSettings.cache_dir || '(default)'"></code></div>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-outline-primary" :disabled="tlsSaveInProgress || tlsActionInProgress" @click="saveTLSSettings()">
            <span x-show="!tlsSaveInProgress">Save TLS Settings</span>
            <span x-show="tlsSaveInProgress">Saving...</span>
          </button>
          <button class="btn btn-outline-secondary" :disabled="tlsActionInProgress || tlsSaveInProgress" @click="testTLSCertificate()">
            <span x-show="!tlsActionInProgress">Get Test Certificate</span>
            <span x-show="tlsActionInProgress">Working...</span>
          </button>
          <button class="btn btn-outline-secondary" :disabled="tlsActionInProgress || tlsSaveInProgress" @click="renewTLSCertificate()">
            <span x-show="!tlsActionInProgress">Force Renew Certificate</span>
            <span x-show="tlsActionInProgress">Working...</span>
          </button>
        </div>
        <div class="small text-body-secondary mt-2">Certificates require public DNS + reachability on ports 80/443 for ACME challenges.</div>
        </div>
      </div>
    </div>

  </div>

  <div x-show="showProvidersSettingsModal" style="display:none;" class="position-fixed top-0 start-0 w-100 h-100" @keydown.escape.window="closeProvidersSettingsModal()">
    <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark" style="opacity:0.5;" @click="closeProvidersSettingsModal()"></div>
    <div class="position-relative d-flex align-items-center justify-content-center h-100 p-3">
      <div class="card shadow" style="width:100%;max-width:620px;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="h5 mb-0">Provider Settings</h3>
          <button class="icon-btn" :disabled="securitySaveInProgress" @click="closeProvidersSettingsModal()" title="Close" aria-label="Close">✕</button>
        </div>
        <div class="card-body">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="autoEnablePublicFreeModelsProviders" x-model="autoEnablePublicFreeModels">
            <label class="form-check-label" for="autoEnablePublicFreeModelsProviders">Automatically enable public free-model providers (no setup required)</label>
          </div>
          <div class="small text-body-secondary mt-2">When enabled, free models from built-in providers are available for use even if no providers are configured manually.</div>
          <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn btn-outline-secondary" :disabled="securitySaveInProgress" @click="closeProvidersSettingsModal()">Cancel</button>
            <button class="btn btn-primary" :disabled="securitySaveInProgress" @click="saveProvidersSettings()">
              <span x-show="!securitySaveInProgress">Save</span>
              <span x-show="securitySaveInProgress">Saving...</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div x-show="showAccessSettingsModal" style="display:none;" class="position-fixed top-0 start-0 w-100 h-100" @keydown.escape.window="closeAccessSettingsModal()">
    <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark" style="opacity:0.5;" @click="closeAccessSettingsModal()"></div>
    <div class="position-relative d-flex align-items-center justify-content-center h-100 p-3">
      <div class="card shadow" style="width:100%;max-width:640px;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="h5 mb-0">API Access Settings</h3>
          <button class="icon-btn" :disabled="securitySaveInProgress" @click="closeAccessSettingsModal()" title="Close" aria-label="Close">✕</button>
        </div>
        <div class="card-body">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="allowLocalhostNoAuthModal" x-model="allowLocalhostNoAuth">
            <label class="form-check-label" for="allowLocalhostNoAuthModal">Allow unauthenticated API access from localhost</label>
          </div>
          <div class="small text-body-secondary mt-2">Only loopback requests (127.0.0.1 / ::1) bypass API key checks when enabled.</div>
          <div class="form-check form-switch mt-3">
            <input class="form-check-input" type="checkbox" id="allowHostDockerInternalNoAuthModal" x-model="allowHostDockerInternalNoAuth">
            <label class="form-check-label" for="allowHostDockerInternalNoAuthModal">Allow unauthenticated API access from host.docker.internal</label>
          </div>
          <div class="small text-body-secondary mt-2">When enabled, requests from the IP resolved by <code>host.docker.internal</code> bypass API key checks.</div>
          <div class="form-check form-switch mt-3">
            <input class="form-check-input" type="checkbox" id="autoRemoveExpiredTokensModal" x-model="autoRemoveExpiredTokens">
            <label class="form-check-label" for="autoRemoveExpiredTokensModal">Auto remove expired access tokens</label>
          </div>
          <div class="small text-body-secondary mt-2">Periodically deletes tokens whose <code>expires_at</code> is in the past.</div>
          <div class="form-check form-switch mt-3">
            <input class="form-check-input" type="checkbox" id="autoRemoveEmptyQuotaTokensModal" x-model="autoRemoveEmptyQuotaTokens">
            <label class="form-check-label" for="autoRemoveEmptyQuotaTokensModal">Auto remove empty non-reset quota tokens</label>
          </div>
          <div class="small text-body-secondary mt-2">Periodically deletes quota-backed tokens that are exhausted and have no reset interval.</div>
          <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn btn-outline-secondary" :disabled="securitySaveInProgress" @click="closeAccessSettingsModal()">Cancel</button>
            <button class="btn btn-primary" :disabled="securitySaveInProgress" @click="saveAccessSettings()">
              <span x-show="!securitySaveInProgress">Save</span>
              <span x-show="securitySaveInProgress">Saving...</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div x-show="activeTab==='models'" style="display:none;">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-2 mb-3">
          <div class="col-md-5"><input class="form-control" placeholder="Search provider or model" x-model="modelsSearch" @input="renderModelsCatalog()" /></div>
          <div class="col-md-7 d-flex justify-content-md-end gap-2">
            <button :class="modelsFreeOnly ? 'btn btn-primary' : 'btn btn-outline-secondary'" @click="toggleFreeOnly()">
              Only free
            </button>
            <button class="btn btn-outline-primary" :disabled="modelsRefreshInProgress" @click="refreshPricingAndModels()">
              <span x-show="!modelsRefreshInProgress">Refresh</span>
              <span x-show="modelsRefreshInProgress">Refreshing...</span>
            </button>
          </div>
        </div>
        <div class="small text-body-secondary mb-2" x-html="modelsFreshnessHtml"></div>
        <div class="table-responsive" x-html="modelsTableHtml"></div>
      </div>
    </div>
  </div>

  <div x-show="modelsInitialLoadInProgress" style="display:none;" class="position-fixed top-0 start-0 w-100 h-100">
    <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark" style="opacity:0.45;"></div>
    <div class="position-relative d-flex align-items-center justify-content-center h-100">
      <div class="card shadow" style="max-width:320px;">
        <div class="card-body text-center py-4">
          <div class="spinner-border text-primary mb-3" role="status" aria-hidden="true"></div>
          <div class="fw-semibold">Working...</div>
          <div class="small text-body-secondary">Fetching models and pricing cache</div>
        </div>
      </div>
    </div>
  </div>

  <div x-show="showAddProviderModal" style="display:none;" class="position-fixed top-0 start-0 w-100 h-100" @keydown.escape.window="closeAddProviderModal()">
    <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark" style="opacity:0.5;" @click="closeAddProviderModal()"></div>
    <div class="position-relative d-flex align-items-center justify-content-center h-100 p-3">
      <div class="card shadow" style="width:100%;max-width:860px;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="h5 mb-0" x-text="addProviderTitle()"></h3>
          <button class="icon-btn" @click="closeAddProviderModal()" title="Close" aria-label="Close">✕</button>
        </div>
        <div class="card-body">
          <div x-show="addProviderStep === 'pick_provider'" style="display:none;">
            <div class="small text-body-secondary mb-3">Choose a provider to configure.</div>
            <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
              <input class="form-control" style="max-width:360px;" placeholder="Search providers..." x-model.trim="providerSearch" />
              <span class="small text-body-secondary">
                <span x-text="filteredPopularProvidersCount()"></span>
                <span>/</span>
                <span x-text="(popularProviders || []).length"></span>
                <span>shown</span>
              </span>
            </div>
            <div class="border rounded p-2" style="max-height:52vh; overflow:auto;">
              <div class="row g-2 row-cols-1 row-cols-md-3">
                <template x-for="p in filteredPopularProviders()" :key="p.name">
                  <div class="col">
                    <button type="button" class="btn border rounded-0 w-100 h-100 p-3 text-start d-flex align-items-center gap-2 provider-preset-btn" @click="selectProviderPreset(p.name)">
                      <img :src="providerIconSrc(p.name)" :class="providerIconNeedsDarkInvert(p.name) ? 'provider-icon-invert-dark' : ''" @error="providerIconError($event)" alt="" width="28" height="28" style="object-fit:contain;" />
                      <span class="fw-semibold" x-text="p.display_name"></span>
                    </button>
                  </div>
                </template>
              </div>
              <div class="small text-body-secondary py-3 text-center" x-show="filteredPopularProvidersCount() === 0" style="display:none;">
                No providers match the current search.
              </div>
            </div>
            <div class="mt-3 d-flex justify-content-end">
              <button class="btn btn-outline-secondary" @click="closeAddProviderModal()">Cancel</button>
            </div>
          </div>

          <div x-show="addProviderStep === 'choose_auth'" style="display:none;">
            <div class="mb-3 d-flex align-items-center gap-2">
              <img :src="providerIconSrc(selectedPreset)" :class="providerIconNeedsDarkInvert(selectedPreset) ? 'provider-icon-invert-dark' : ''" @error="providerIconError($event)" alt="" width="28" height="28" style="object-fit:contain;" />
              <span class="fw-semibold" x-text="selectedPresetDisplayName()"></span>
            </div>
            <div class="small text-body-secondary mb-3">Choose how you want to authenticate.</div>
            <div class="row g-2 align-items-stretch">
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-primary rounded-0 w-100 h-100 p-3 text-start d-flex flex-column auth-choice-btn" @click="chooseApiKeyAuth()">
                  <div class="fw-semibold">Use API key</div>
                  <div class="small text-body-secondary">Paste and validate a key, then save provider.</div>
                </button>
              </div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-primary rounded-0 w-100 h-100 p-3 text-start d-flex flex-column auth-choice-btn" @click="chooseAlternateAuth()">
                  <div class="fw-semibold" x-text="alternateAuthTitle()"></div>
                  <div class="small text-body-secondary" x-text="alternateAuthDescription()"></div>
                </button>
              </div>
            </div>
            <div class="mt-3 d-flex justify-content-between">
              <button class="btn btn-outline-secondary" @click="goBackFromChoice()">Back</button>
              <button class="btn btn-outline-secondary" @click="closeAddProviderModal()">Cancel</button>
            </div>
          </div>

          <div x-show="addProviderStep === 'api_key'" style="display:none;">
            <div class="mb-2">
              <button class="btn btn-sm btn-outline-secondary" @click="goBackFromForm()">Back</button>
            </div>
            <div class="small text-body-secondary mb-2" x-show="presetInfoHtml" x-html="presetInfoHtml"></div>
            <div class="row g-2 mb-2">
              <div class="col-md-4">
                <label class="form-label">Name</label>
                <input class="form-control" x-model="draft.name" placeholder="name" />
              </div>
              <div class="col-md-8" x-show="selectedPresetRequiresBaseURLInput() || overrideProviderSettings || !selectedPreset" style="display:none;">
                <label class="form-label">Base URL</label>
                <input class="form-control" x-model="draft.base_url" :placeholder="selectedPresetBaseURLTemplate() || 'base_url'" />
                <div class="small text-body-secondary mt-1" x-show="selectedPresetBaseURLHint()" x-text="selectedPresetBaseURLHint()" style="display:none;"></div>
                <div class="small text-body-secondary" x-show="selectedPresetBaseURLExample()" style="display:none;">
                  Example: <code x-text="selectedPresetBaseURLExample()"></code>
                </div>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">API Key</label>
              <input class="form-control" x-model="draft.api_key" :placeholder="selectedPresetApiKeyOptional() ? 'optional api_key' : 'api_key'" />
              <div class="small text-body-secondary mt-1" x-show="selectedPresetGetKeyURL()" style="display:none;">
                <a :href="selectedPresetGetKeyURL()" target="_blank" rel="noopener noreferrer">Get API key</a>
              </div>
            </div>
            <div class="form-check form-switch mb-2" x-show="selectedPreset" style="display:none;">
              <input class="form-check-input" type="checkbox" id="overrideProviderSettingsApi" x-model="overrideProviderSettings">
              <label class="form-check-label" for="overrideProviderSettingsApi">Override preset endpoint/timeouts</label>
            </div>
            <div class="row g-2 mb-2" x-show="(overrideProviderSettings || !selectedPreset) && !selectedPresetRequiresBaseURLInput()" style="display:none;">
              <div class="col-md-4">
                <label class="form-label">Timeout Seconds</label>
                <input class="form-control" type="number" min="1" x-model="draft.timeout_seconds" />
              </div>
            </div>
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="providerEnabledApi" x-model="draft.enabled">
              <label class="form-check-label" for="providerEnabledApi">Enabled</label>
            </div>
            <div class="small mb-2" x-html="modalStatusHtml"></div>
            <div class="d-flex gap-2 justify-content-end">
              <button class="btn btn-outline-secondary" @click="closeAddProviderModal()">Cancel</button>
              <button class="btn btn-outline-primary" @click="testProvider()">Test</button>
              <button class="btn btn-primary" @click="saveProvider()">Save</button>
            </div>
          </div>

          <div x-show="addProviderStep === 'oauth_browser'" style="display:none;">
            <div class="mb-2">
              <button class="btn btn-sm btn-outline-secondary" @click="goBackFromForm()">Back</button>
            </div>
            <div class="mb-2 d-flex align-items-center gap-2">
              <img :src="providerIconSrc(selectedPreset)" :class="providerIconNeedsDarkInvert(selectedPreset) ? 'provider-icon-invert-dark' : ''" @error="providerIconError($event)" alt="" width="28" height="28" style="object-fit:contain;" />
              <span class="fw-semibold" x-text="selectedPresetDisplayName()"></span>
            </div>
            <div class="small text-body-secondary mb-3">Use official ChatGPT/Codex browser login. After successful sign-in, tokens are captured and stored automatically.</div>
            <div class="mb-2 d-flex gap-2">
              <button class="btn btn-outline-primary" type="button" @click="startOAuthBrowserLogin()" :disabled="oauthLoginInProgress">
                <span x-show="!oauthLoginInProgress">Start Browser Login</span>
                <span x-show="oauthLoginInProgress">Waiting for login...</span>
              </button>
              <button class="btn btn-outline-secondary" type="button" @click="cancelOAuthPolling()" :disabled="!oauthLoginInProgress">Cancel</button>
            </div>
            <div class="small text-body-secondary mb-2">If the browser did not open, allow popups and retry. This uses the same OpenAI OAuth flow as Codex tooling.</div>
            <div class="mb-2">
              <button class="btn btn-sm btn-outline-secondary" type="button" @click="oauthAdvanced = !oauthAdvanced">
                <span x-show="!oauthAdvanced">Show advanced OAuth settings</span>
                <span x-show="oauthAdvanced">Hide advanced OAuth settings</span>
              </button>
            </div>
            <div class="border rounded p-2 mb-2" x-show="oauthAdvanced" style="display:none;">
              <div class="row g-2">
                <div class="col-12">
                  <label class="form-label mb-1">Authorize URL</label>
                  <input class="form-control" x-model="draft.oauth_authorize_url" placeholder="https://.../oauth/authorize" />
                </div>
                <div class="col-12">
                  <label class="form-label mb-1">Token URL</label>
                  <input class="form-control" x-model="draft.oauth_token_url" placeholder="https://.../oauth/token" />
                </div>
                <div class="col-md-6">
                  <label class="form-label mb-1">Client ID</label>
                  <input class="form-control" x-model="draft.oauth_client_id" placeholder="oauth client id" />
                </div>
                <div class="col-md-6">
                  <label class="form-label mb-1">Client Secret (optional)</label>
                  <input class="form-control" x-model="draft.oauth_client_secret" placeholder="oauth client secret" />
                </div>
                <div class="col-12">
                  <label class="form-label mb-1">Scope (optional)</label>
                  <input class="form-control" x-model="draft.oauth_scope" placeholder="openid profile email offline_access" />
                </div>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Auth Token</label>
              <input class="form-control" x-model="draft.auth_token" placeholder="filled after browser login" />
            </div>
            <div class="small mb-2" x-html="modalStatusHtml"></div>
            <div class="d-flex gap-2 justify-content-end">
              <button class="btn btn-outline-secondary" @click="closeAddProviderModal()">Cancel</button>
              <button class="btn btn-primary" @click="saveProvider()">Save</button>
            </div>
          </div>

          <div x-show="addProviderStep === 'device_auth'" style="display:none;">
            <div class="mb-2">
              <button class="btn btn-sm btn-outline-secondary" @click="goBackFromForm()">Back</button>
            </div>
            <div class="mb-2 d-flex align-items-center gap-2">
              <img :src="providerIconSrc(selectedPreset)" :class="providerIconNeedsDarkInvert(selectedPreset) ? 'provider-icon-invert-dark' : ''" @error="providerIconError($event)" alt="" width="28" height="28" style="object-fit:contain;" />
              <span class="fw-semibold" x-text="selectedPresetDisplayName()"></span>
            </div>
            <div class="small text-body-secondary mb-3">Step 1: enter a device code and open the provider binding page. Step 2: finish login there and paste the returned token here.</div>
            <div class="mb-2" x-show="selectedPresetSupportsDeviceCodeFetch()" style="display:none;">
              <label class="form-label">Device Code Request</label>
              <div class="row g-2">
                <div class="col-md-7">
                  <input class="form-control" x-model="draft.device_client_id" placeholder="OAuth client_id" />
                </div>
                <div class="col-md-5 d-grid">
                  <button class="btn btn-outline-primary" type="button" @click="fetchDeviceCode()" :disabled="deviceCodeFetchInProgress">
                    <span x-show="!deviceCodeFetchInProgress">Fetch Device Code</span>
                    <span x-show="deviceCodeFetchInProgress">Fetching...</span>
                  </button>
                </div>
              </div>
              <div class="mt-2">
                <input class="form-control" x-model="draft.device_scope" placeholder="OAuth scope" />
              </div>
              <div class="small text-body-secondary mt-1">Uses provider device-code endpoint and auto-fills code + verification URL.</div>
            </div>
            <div class="mb-2" x-show="draft.device_token_url || selectedPresetSupportsDeviceTokenPolling()" style="display:none;">
              <label class="form-label">Device Token Exchange</label>
              <div class="input-group">
                <input class="form-control" x-model="draft.device_token_url" placeholder="device token URL" />
                <button class="btn btn-outline-primary" type="button" @click="pollDeviceToken()" :disabled="deviceTokenPollInProgress || !selectedPresetSupportsDeviceTokenPolling()">
                  <span x-show="!deviceTokenPollInProgress">Poll Token</span>
                  <span x-show="deviceTokenPollInProgress">Polling...</span>
                </button>
              </div>
              <div class="mt-2">
                <input class="form-control" x-model="draft.device_grant_type" placeholder="grant type (defaults to device_code)" />
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Device Code</label>
              <div class="input-group">
                <input class="form-control" x-model="draft.device_code" placeholder="ABCD-EFGH" />
                <button class="btn btn-outline-secondary" type="button" @click="copyDeviceCode()" :disabled="!draft.device_code">Copy</button>
              </div>
              <div class="small text-body-secondary mt-1">
                Enter the pairing code shown by your provider. You can copy it or open the binding page with this code.
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Binding Page</label>
              <div class="form-control bg-body-tertiary text-break" x-text="draft.device_auth_url || 'No device auth URL configured for this provider.'"></div>
              <div class="small text-body-secondary mt-2 d-flex flex-wrap gap-2 align-items-center">
                <button class="btn btn-sm btn-outline-primary" type="button" @click="openDeviceAuth(false)" :disabled="!draft.device_auth_url">Open binding page</button>
                <button class="btn btn-sm btn-outline-primary" type="button" @click="openDeviceAuth(true)" :disabled="!draft.device_auth_url">Open with code</button>
              </div>
              <div class="small text-body-secondary mt-1" x-show="deviceAuthURLWithCode()" style="display:none;">
                Prefilled URL: <a :href="deviceAuthURLWithCode()" target="_blank" rel="noopener noreferrer" x-text="deviceAuthURLWithCode()"></a>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Auth Token</label>
              <input class="form-control" x-model="draft.auth_token" placeholder="device auth token" />
            </div>
            <div class="small mb-2" x-html="modalStatusHtml"></div>
            <div class="d-flex gap-2 justify-content-end">
              <button class="btn btn-outline-secondary" @click="closeAddProviderModal()">Cancel</button>
              <button class="btn btn-outline-primary" @click="testProvider()">Test</button>
              <button class="btn btn-primary" @click="saveProvider()">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div x-show="showAddAccessTokenModal" style="display:none;" class="position-fixed top-0 start-0 w-100 h-100" @keydown.escape.window="closeAddAccessTokenModal()">
    <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark" style="opacity:0.5;" @click="!requiresInitialTokenSetup && closeAddAccessTokenModal()"></div>
    <div class="position-relative d-flex align-items-center justify-content-center h-100 p-3">
      <div class="card shadow" style="width:100%;max-width:640px;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="h5 mb-0" x-text="accessTokenDraft.id ? 'Edit Access Key' : 'Add Access Key'"></h3>
          <button class="icon-btn" x-show="!requiresInitialTokenSetup" style="display:none;" @click="closeAddAccessTokenModal()" title="Close" aria-label="Close">✕</button>
        </div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-md-5">
              <label class="form-label">Token Name</label>
              <input class="form-control" x-model="accessTokenDraft.name" placeholder="Required name" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Type</label>
              <select class="form-select" x-model="accessTokenDraft.role" required>
                <option value="inferrer">inferrer</option>
                <option value="keymaster">keymaster</option>
                <option value="admin">admin</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Expiry</label>
              <select class="form-select" x-model="accessTokenDraft.expiry_preset">
                <option value="1d">1 day</option>
                <option value="1w">1 week</option>
                <option value="1m">1 month</option>
                <option value="3m">3 months</option>
                <option value="12m">12 months</option>
                <option value="never">Never</option>
                <option value="custom" x-show="accessTokenDraft.id" style="display:none;">Custom</option>
              </select>
            </div>
          </div>
          <div class="mt-3" x-show="accessTokenDraft.expiry_preset === 'custom'" style="display:none;">
            <label class="form-label">Custom Expiry (RFC3339)</label>
            <input class="form-control" x-model="accessTokenDraft.expires_at" placeholder="2026-12-31T23:59:59Z" />
          </div>
          <div class="mt-3 border rounded p-3">
            <div class="form-check form-switch mb-2">
              <input class="form-check-input" type="checkbox" id="accessTokenQuotaEnabled" x-model="accessTokenDraft.quota_enabled">
              <label class="form-check-label" for="accessTokenQuotaEnabled">Enable quota</label>
            </div>
            <div class="row g-2" x-show="accessTokenDraft.quota_enabled" style="display:none;">
              <div class="col-md-6">
                <label class="form-label">Requests limit</label>
                <input class="form-control" type="number" min="1" step="1" x-model="accessTokenDraft.quota_requests_limit" placeholder="e.g. 10000" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Requests renew every (seconds, 0 = never)</label>
                <input class="form-control" type="number" min="0" step="1" x-model="accessTokenDraft.quota_requests_interval_seconds" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Tokens limit</label>
                <input class="form-control" type="number" min="1" step="1" x-model="accessTokenDraft.quota_tokens_limit" placeholder="e.g. 1000000" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Tokens renew every (seconds, 0 = never)</label>
                <input class="form-control" type="number" min="0" step="1" x-model="accessTokenDraft.quota_tokens_interval_seconds" />
              </div>
            </div>
          </div>
          <div class="mt-3" x-show="!accessTokenDraft.id" style="display:none;">
            <label class="form-label">Key</label>
            <div class="input-group">
              <input class="form-control" x-model="accessTokenDraft.key" @click="copyAccessTokenKey()" title="Click to copy key" />
              <button class="btn btn-outline-secondary" type="button" @click="copyAccessTokenKey()">Copy</button>
              <button class="btn btn-outline-secondary" type="button" @click="regenerateAccessTokenKey()">Generate</button>
            </div>
          </div>
          <div class="small text-body-secondary mt-2" x-show="!accessTokenDraft.id" style="display:none;">A random long key is generated by default. You can regenerate or edit before saving.</div>
          <div class="small text-body-secondary mt-2" x-show="accessTokenDraft.id" style="display:none;">API key value is hidden after creation and cannot be changed.</div>
          <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn btn-outline-secondary" x-show="!requiresInitialTokenSetup" style="display:none;" @click="closeAddAccessTokenModal()">Cancel</button>
            <button class="btn btn-primary" @click="saveAccessToken()">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div x-show="showConfirmModal" style="display:none;" class="position-fixed top-0 start-0 w-100 h-100" @keydown.escape.window="closeConfirmModal()">
    <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark" style="opacity:0.5;" @click="closeConfirmModal()"></div>
    <div class="position-relative d-flex align-items-center justify-content-center h-100 p-3">
      <div class="card shadow" style="width:100%;max-width:520px;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="h5 mb-0" x-text="confirmModalTitle"></h3>
          <button class="icon-btn" :disabled="confirmModalBusy" @click="closeConfirmModal()" title="Close" aria-label="Close">✕</button>
        </div>
        <div class="card-body">
          <p class="mb-3" x-text="confirmModalMessage"></p>
          <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-outline-secondary" :disabled="confirmModalBusy" @click="closeConfirmModal()">Cancel</button>
            <button class="btn btn-danger" :disabled="confirmModalBusy" @click="confirmModalProceed()">
              <span x-show="!confirmModalBusy" x-text="confirmModalConfirmLabel"></span>
              <span x-show="confirmModalBusy">Working...</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>
