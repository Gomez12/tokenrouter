<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenAI Personal Proxy Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script defer src="/admin/static/admin.js"></script>
  <style>
    [data-bs-theme="light"] body {
      background-color: #eef2f6 !important;
    }

    [data-bs-theme="dark"] body {
      background-color: #343b46 !important;
    }

    .auth-choice-btn {
      min-height: 120px;
    }
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-body-tertiary">
<div class="container-fluid px-4 py-4" x-data="adminApp()" x-init="init()">
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex align-items-start justify-content-between gap-2">
        <div>
          <h1 class="h3 mb-1">OpenAI Personal Proxy</h1>
          <p class="text-body-secondary mb-0">Authenticated admin interface with live updates.</p>
        </div>
        <div class="d-flex gap-2">
          <button
            class="btn btn-sm btn-outline-secondary"
            type="button"
            @click="cycleTheme()"
            :title="themeButtonLabel()"
            :aria-label="themeButtonLabel()"
          >
            <span aria-hidden="true" x-html="themeButtonIcon()"></span>
          </button>
          <form method="post" action="/admin/logout">
            <button class="btn btn-sm btn-outline-secondary" type="submit">Log out</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <ul class="nav nav-tabs mb-0">
    <li class="nav-item">
      <button class="nav-link rounded-top" :class="activeTab==='status' ? 'active fw-semibold' : 'text-body-secondary'" @click="selectTab('status')">Status</button>
    </li>
    <li class="nav-item">
      <button class="nav-link rounded-top" :class="activeTab==='quota' ? 'active fw-semibold' : 'text-body-secondary'" @click="selectTab('quota')">Quota</button>
    </li>
    <li class="nav-item">
      <button class="nav-link rounded-top" :class="activeTab==='providers' ? 'active fw-semibold' : 'text-body-secondary'" @click="selectTab('providers')">Providers</button>
    </li>
    <li class="nav-item">
      <button class="nav-link rounded-top" :class="activeTab==='access' ? 'active fw-semibold' : 'text-body-secondary'" @click="selectTab('access')">Access</button>
    </li>
    <li class="nav-item">
      <button class="nav-link rounded-top" :class="activeTab==='models' ? 'active fw-semibold' : 'text-body-secondary'" @click="selectTab('models')">Models</button>
    </li>
  </ul>

  <div x-show="activeTab==='status'" style="display:none;">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 mb-0">Usage Stats</h2>
          <div class="d-flex align-items-center gap-2">
            <select class="form-select form-select-sm" style="width:auto;" x-model="statsRangeHours" @change="loadStats(true)">
              <option value="1">1h</option>
              <option value="4">4h</option>
              <option value="8">8h</option>
              <option value="24">24h</option>
              <option value="72">72h</option>
            </select>
            <button class="btn btn-sm btn-outline-primary" @click="loadStats(true)">Refresh</button>
          </div>
        </div>
        <div x-html="statsSummaryHtml"></div>
      </div>
    </div>
  </div>

  <div x-show="activeTab==='quota'" style="display:none;">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 mb-0">Provider Quotas</h2>
          <button class="btn btn-sm btn-outline-primary" @click="loadStats(true)">Refresh</button>
        </div>
        <div x-html="quotaSummaryHtml"></div>
      </div>
    </div>
  </div>

  <div x-show="activeTab==='providers'" style="display:none;">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 mb-0">Providers</h2>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-primary" @click="openAddProviderModal()">Add Provider</button>
          </div>
        </div>
        <div class="table-responsive" x-html="providersTableHtml"></div>
      </div>
    </div>
  </div>

  <div x-show="activeTab==='access'" style="display:none;">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h5 mb-0">Access Tokens</h2>
          <button class="btn btn-sm btn-primary" @click="openAddAccessTokenModal()">Add Key</button>
        </div>
        <div class="small mb-2" x-show="accessTokenStatusHtml" style="display:none;" x-html="accessTokenStatusHtml"></div>
        <div class="table-responsive" x-html="accessTokensTableHtml"></div>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="mb-2"><h2 class="h5 mb-0">API Access</h2></div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="allowLocalhostNoAuth" x-model="allowLocalhostNoAuth" @change="saveSecuritySettings()">
          <label class="form-check-label" for="allowLocalhostNoAuth">Allow unauthenticated API access from localhost</label>
        </div>
        <div class="small text-body-secondary mt-2">Only loopback requests (127.0.0.1 / ::1) bypass API key checks when enabled.</div>
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="allowHostDockerInternalNoAuth" x-model="allowHostDockerInternalNoAuth" @change="saveSecuritySettings()">
          <label class="form-check-label" for="allowHostDockerInternalNoAuth">Allow unauthenticated API access from host.docker.internal</label>
        </div>
        <div class="small text-body-secondary mt-2">When enabled, requests from the IP resolved by <code>host.docker.internal</code> bypass API key checks.</div>
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="autoEnablePublicFreeModels" x-model="autoEnablePublicFreeModels" @change="saveSecuritySettings()">
          <label class="form-check-label" for="autoEnablePublicFreeModels">Automatically enable public free-model providers (no setup required)</label>
        </div>
        <div class="small text-body-secondary mt-2">When enabled, free models from built-in providers are available for use even if no providers are configured manually.</div>
      </div>
    </div>

    <div class="card shadow-sm mb-3" x-show="statusHtml" style="display:none;">
      <div class="card-body">
        <div class="small text-body-secondary" x-html="statusHtml"></div>
      </div>
    </div>
  </div>

  <div x-show="activeTab==='models'" style="display:none;">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-2 mb-3">
          <div class="col-md-5"><input class="form-control" placeholder="Search provider or model" x-model="modelsSearch" @input="renderModelsCatalog()" /></div>
          <div class="col-md-7 d-flex justify-content-md-end gap-2">
            <button :class="modelsFreeOnly ? 'btn btn-primary' : 'btn btn-outline-secondary'" @click="toggleFreeOnly()">
              Only free
            </button>
            <button class="btn btn-outline-primary" :disabled="modelsRefreshInProgress" @click="refreshPricingAndModels()">
              <span x-show="!modelsRefreshInProgress">Refresh</span>
              <span x-show="modelsRefreshInProgress">Refreshing...</span>
            </button>
          </div>
        </div>
        <div class="small text-body-secondary mb-2" x-html="modelsFreshnessHtml"></div>
        <div class="table-responsive" x-html="modelsTableHtml"></div>
      </div>
    </div>
  </div>

  <div x-show="modelsInitialLoadInProgress" style="display:none;" class="position-fixed top-0 start-0 w-100 h-100">
    <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark" style="opacity:0.45;"></div>
    <div class="position-relative d-flex align-items-center justify-content-center h-100">
      <div class="card shadow" style="max-width:320px;">
        <div class="card-body text-center py-4">
          <div class="spinner-border text-primary mb-3" role="status" aria-hidden="true"></div>
          <div class="fw-semibold">Working...</div>
          <div class="small text-body-secondary">Fetching models and pricing cache</div>
        </div>
      </div>
    </div>
  </div>

  <div x-show="showAddProviderModal" style="display:none;" class="position-fixed top-0 start-0 w-100 h-100" @keydown.escape.window="closeAddProviderModal()">
    <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark" style="opacity:0.5;" @click="closeAddProviderModal()"></div>
    <div class="position-relative d-flex align-items-center justify-content-center h-100 p-3">
      <div class="card shadow" style="width:100%;max-width:860px;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="h5 mb-0" x-text="addProviderTitle()"></h3>
          <button class="btn btn-sm btn-outline-secondary" @click="closeAddProviderModal()">X</button>
        </div>
        <div class="card-body">
          <div x-show="addProviderStep === 'pick_provider'" style="display:none;">
            <div class="small text-body-secondary mb-3">Choose a provider to configure.</div>
            <div class="row g-2 row-cols-1 row-cols-md-3">
              <template x-for="p in popularProviders" :key="p.name">
                <div class="col">
                  <button type="button" class="btn btn-light border rounded-0 w-100 h-100 p-3 text-start d-flex align-items-center gap-2" @click="selectProviderPreset(p.name)">
                    <img :src="providerIconSrc(p.name)" @error="providerIconError($event)" alt="" width="28" height="28" style="object-fit:contain;" />
                    <span class="fw-semibold" x-text="p.display_name"></span>
                  </button>
                </div>
              </template>
            </div>
            <div class="mt-3 d-flex justify-content-end">
              <button class="btn btn-outline-secondary" @click="closeAddProviderModal()">Cancel</button>
            </div>
          </div>

          <div x-show="addProviderStep === 'choose_auth'" style="display:none;">
            <div class="mb-3 d-flex align-items-center gap-2">
              <img :src="providerIconSrc(selectedPreset)" @error="providerIconError($event)" alt="" width="28" height="28" style="object-fit:contain;" />
              <span class="fw-semibold" x-text="selectedPresetDisplayName()"></span>
            </div>
            <div class="small text-body-secondary mb-3">Choose how you want to authenticate.</div>
            <div class="row g-2 align-items-stretch">
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-primary rounded-0 w-100 h-100 p-3 text-start d-flex flex-column auth-choice-btn" @click="chooseApiKeyAuth()">
                  <div class="fw-semibold">Use API key</div>
                  <div class="small text-body-secondary">Paste and validate a key, then save provider.</div>
                </button>
              </div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-primary rounded-0 w-100 h-100 p-3 text-start d-flex flex-column auth-choice-btn" @click="chooseAlternateAuth()">
                  <div class="fw-semibold" x-text="alternateAuthTitle()"></div>
                  <div class="small text-body-secondary" x-text="alternateAuthDescription()"></div>
                </button>
              </div>
            </div>
            <div class="mt-3 d-flex justify-content-between">
              <button class="btn btn-outline-secondary" @click="goBackFromChoice()">Back</button>
              <button class="btn btn-outline-secondary" @click="closeAddProviderModal()">Cancel</button>
            </div>
          </div>

          <div x-show="addProviderStep === 'api_key'" style="display:none;">
            <div class="mb-2">
              <button class="btn btn-sm btn-outline-secondary" @click="goBackFromForm()">Back</button>
            </div>
            <div class="small text-body-secondary mb-2" x-show="presetInfoHtml" x-html="presetInfoHtml"></div>
            <div class="row g-2 mb-2">
              <div class="col-md-4">
                <label class="form-label">Name</label>
                <input class="form-control" x-model="draft.name" placeholder="name" />
              </div>
              <div class="col-md-8" x-show="selectedPresetRequiresBaseURLInput() || overrideProviderSettings || !selectedPreset" style="display:none;">
                <label class="form-label">Base URL</label>
                <input class="form-control" x-model="draft.base_url" :placeholder="selectedPresetBaseURLTemplate() || 'base_url'" />
                <div class="small text-body-secondary mt-1" x-show="selectedPresetBaseURLHint()" x-text="selectedPresetBaseURLHint()" style="display:none;"></div>
                <div class="small text-body-secondary" x-show="selectedPresetBaseURLExample()" style="display:none;">
                  Example: <code x-text="selectedPresetBaseURLExample()"></code>
                </div>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">API Key</label>
              <input class="form-control" x-model="draft.api_key" :placeholder="selectedPresetApiKeyOptional() ? 'optional api_key' : 'api_key'" />
              <div class="small text-body-secondary mt-1" x-show="selectedPresetGetKeyURL()" style="display:none;">
                <a :href="selectedPresetGetKeyURL()" target="_blank" rel="noopener noreferrer">Get API key</a>
              </div>
            </div>
            <div class="form-check mb-2" x-show="selectedPreset" style="display:none;">
              <input class="form-check-input" type="checkbox" id="overrideProviderSettingsApi" x-model="overrideProviderSettings">
              <label class="form-check-label" for="overrideProviderSettingsApi">Override preset endpoint/timeouts</label>
            </div>
            <div class="row g-2 mb-2" x-show="(overrideProviderSettings || !selectedPreset) && !selectedPresetRequiresBaseURLInput()" style="display:none;">
              <div class="col-md-4">
                <label class="form-label">Timeout Seconds</label>
                <input class="form-control" type="number" min="1" x-model="draft.timeout_seconds" />
              </div>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="providerEnabledApi" x-model="draft.enabled">
              <label class="form-check-label" for="providerEnabledApi">Enabled</label>
            </div>
            <div class="small mb-2" x-html="modalStatusHtml"></div>
            <div class="d-flex gap-2 justify-content-end">
              <button class="btn btn-outline-secondary" @click="closeAddProviderModal()">Cancel</button>
              <button class="btn btn-outline-primary" @click="testProvider()">Test</button>
              <button class="btn btn-primary" @click="saveProvider()">Save</button>
            </div>
          </div>

          <div x-show="addProviderStep === 'oauth_browser'" style="display:none;">
            <div class="mb-2">
              <button class="btn btn-sm btn-outline-secondary" @click="goBackFromForm()">Back</button>
            </div>
            <div class="mb-2 d-flex align-items-center gap-2">
              <img :src="providerIconSrc(selectedPreset)" @error="providerIconError($event)" alt="" width="28" height="28" style="object-fit:contain;" />
              <span class="fw-semibold" x-text="selectedPresetDisplayName()"></span>
            </div>
            <div class="small text-body-secondary mb-3">Use official ChatGPT/Codex browser login. After successful sign-in, tokens are captured and stored automatically.</div>
            <div class="mb-2 d-flex gap-2">
              <button class="btn btn-outline-primary" type="button" @click="startOAuthBrowserLogin()" :disabled="oauthLoginInProgress">
                <span x-show="!oauthLoginInProgress">Start Browser Login</span>
                <span x-show="oauthLoginInProgress">Waiting for login...</span>
              </button>
              <button class="btn btn-outline-secondary" type="button" @click="cancelOAuthPolling()" :disabled="!oauthLoginInProgress">Cancel</button>
            </div>
            <div class="small text-body-secondary mb-2">If the browser did not open, allow popups and retry. This uses the same OpenAI OAuth flow as Codex tooling.</div>
            <div class="mb-2">
              <label class="form-label">Auth Token</label>
              <input class="form-control" x-model="draft.auth_token" placeholder="filled after browser login" />
            </div>
            <div class="small mb-2" x-html="modalStatusHtml"></div>
            <div class="d-flex gap-2 justify-content-end">
              <button class="btn btn-outline-secondary" @click="closeAddProviderModal()">Cancel</button>
              <button class="btn btn-primary" @click="saveProvider()">Save</button>
            </div>
          </div>

          <div x-show="addProviderStep === 'device_auth'" style="display:none;">
            <div class="mb-2">
              <button class="btn btn-sm btn-outline-secondary" @click="goBackFromForm()">Back</button>
            </div>
            <div class="mb-2 d-flex align-items-center gap-2">
              <img :src="providerIconSrc(selectedPreset)" @error="providerIconError($event)" alt="" width="28" height="28" style="object-fit:contain;" />
              <span class="fw-semibold" x-text="selectedPresetDisplayName()"></span>
            </div>
            <div class="small text-body-secondary mb-3">Step 1: enter a device code and open the provider binding page. Step 2: finish login there and paste the returned token here.</div>
            <div class="mb-2" x-show="selectedPresetSupportsDeviceCodeFetch()" style="display:none;">
              <label class="form-label">Device Code Request</label>
              <div class="row g-2">
                <div class="col-md-7">
                  <input class="form-control" x-model="draft.device_client_id" placeholder="OAuth client_id" />
                </div>
                <div class="col-md-5 d-grid">
                  <button class="btn btn-outline-primary" type="button" @click="fetchDeviceCode()" :disabled="deviceCodeFetchInProgress">
                    <span x-show="!deviceCodeFetchInProgress">Fetch Device Code</span>
                    <span x-show="deviceCodeFetchInProgress">Fetching...</span>
                  </button>
                </div>
              </div>
              <div class="mt-2">
                <input class="form-control" x-model="draft.device_scope" placeholder="OAuth scope" />
              </div>
              <div class="small text-body-secondary mt-1">Uses provider device-code endpoint and auto-fills code + verification URL.</div>
            </div>
            <div class="mb-2">
              <label class="form-label">Device Code</label>
              <div class="input-group">
                <input class="form-control" x-model="draft.device_code" placeholder="ABCD-EFGH" />
                <button class="btn btn-outline-secondary" type="button" @click="copyDeviceCode()" :disabled="!draft.device_code">Copy</button>
              </div>
              <div class="small text-body-secondary mt-1">
                Enter the pairing code shown by your provider. You can copy it or open the binding page with this code.
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Binding Page</label>
              <div class="form-control bg-body-tertiary text-break" x-text="draft.device_auth_url || 'No device auth URL configured for this provider.'"></div>
              <div class="small text-body-secondary mt-2 d-flex flex-wrap gap-2 align-items-center">
                <button class="btn btn-sm btn-outline-primary" type="button" @click="openDeviceAuth(false)" :disabled="!draft.device_auth_url">Open binding page</button>
                <button class="btn btn-sm btn-outline-primary" type="button" @click="openDeviceAuth(true)" :disabled="!draft.device_auth_url">Open with code</button>
              </div>
              <div class="small text-body-secondary mt-1" x-show="deviceAuthURLWithCode()" style="display:none;">
                Prefilled URL: <a :href="deviceAuthURLWithCode()" target="_blank" rel="noopener noreferrer" x-text="deviceAuthURLWithCode()"></a>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Auth Token</label>
              <input class="form-control" x-model="draft.auth_token" placeholder="device auth token" />
            </div>
            <div class="small mb-2" x-html="modalStatusHtml"></div>
            <div class="d-flex gap-2 justify-content-end">
              <button class="btn btn-outline-secondary" @click="closeAddProviderModal()">Cancel</button>
              <button class="btn btn-outline-primary" @click="testProvider()">Test</button>
              <button class="btn btn-primary" @click="saveProvider()">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div x-show="showAddAccessTokenModal" style="display:none;" class="position-fixed top-0 start-0 w-100 h-100" @keydown.escape.window="closeAddAccessTokenModal()">
    <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark" style="opacity:0.5;" @click="closeAddAccessTokenModal()"></div>
    <div class="position-relative d-flex align-items-center justify-content-center h-100 p-3">
      <div class="card shadow" style="width:100%;max-width:640px;">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="h5 mb-0">Add Access Key</h3>
          <button class="btn btn-sm btn-outline-secondary" @click="closeAddAccessTokenModal()">X</button>
        </div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-md-5">
              <label class="form-label">Token Name</label>
              <input class="form-control" x-model="accessTokenDraft.name" placeholder="Required name" />
            </div>
            <div class="col-md-7">
              <label class="form-label">Expiry</label>
              <select class="form-select" x-model="accessTokenDraft.expiry_preset">
                <option value="1d">1 day</option>
                <option value="1w">1 week</option>
                <option value="1m">1 month</option>
                <option value="3m">3 months</option>
                <option value="12m">12 months</option>
                <option value="never">Never</option>
              </select>
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label">Key</label>
            <div class="input-group">
              <input class="form-control" x-model="accessTokenDraft.key" />
              <button class="btn btn-outline-secondary" type="button" @click="regenerateAccessTokenKey()">Generate</button>
            </div>
          </div>
          <div class="small text-body-secondary mt-2">A random long key is generated by default. You can regenerate or edit before saving.</div>
          <div class="small mt-2" x-show="accessTokenStatusHtml" style="display:none;" x-html="accessTokenStatusHtml"></div>
          <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn btn-outline-secondary" @click="closeAddAccessTokenModal()">Cancel</button>
            <button class="btn btn-primary" @click="saveAccessToken()">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>
